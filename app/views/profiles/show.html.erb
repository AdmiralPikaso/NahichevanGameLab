<div class="container">
  <% if @user && @user.profile %>
    <div class="row">
      <div class="col-md-4">
        <div class="card mb-4">
          <div class="card-body text-center">
            <!-- –ê–≤–∞—Ç–∞—Ä -->
            <% if @user.profile.avatar.attached? %>
              <%= image_tag @user.profile.avatar.variant(resize: "150x150"), 
                    class: "rounded-circle mb-3",
                    style: "width: 150px; height: 150px; object-fit: cover;" %>
            <% else %>
              <div class="rounded-circle bg-secondary d-flex align-items-center justify-content-center mx-auto mb-3" 
                   style="width: 150px; height: 150px;">
                <span class="text-white display-4"><%= @user.email[0].upcase %></span>
              </div>
            <% end %>
            
            <!-- –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
            <h4><%= @user.email %></h4>
            
            <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
            <div class="row text-center mt-3">
              <div class="col-6">
                <h5 class="mb-0"><%= @collections_count || 0 %></h5>
                <small class="text-muted">–ö–æ–ª–ª–µ–∫—Ü–∏–π</small>
              </div>
              <div class="col-6">
                <h5 class="mb-0"><%= @games_count || 0 %></h5>
                <small class="text-muted">–ò–≥—Ä –≤—Å–µ–≥–æ</small>
              </div>
            </div>
            
            <!-- –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π -->
            <% if @user != current_user %>
              <div class="mt-3">
                <% 
                  # –ü–æ–ª—É—á–∞–µ–º —Å—Ç–∞—Ç—É—Å –¥—Ä—É–∂–±—ã —Å –ø–æ–º–æ—â—å—é –º–µ—Ç–æ–¥–∞ –∏–∑ –º–æ–¥–µ–ª–∏ User
                  friendship_status = current_user.friendship_status_with(@user)
                  
                  if friendship_status == :friends
                    # –£–∂–µ –¥—Ä—É–∑—å—è - –Ω–∞—Ö–æ–¥–∏–º –∑–∞–ø–∏—Å—å –æ –¥—Ä—É–∂–±–µ
                    friendship_record = current_user.friendship_with(@user)
                %>
                  <span class="badge bg-success mb-2">–î—Ä—É–≥</span>
                  <% if friendship_record %>
                    <%= button_to "–£–¥–∞–ª–∏—Ç—å –∏–∑ –¥—Ä—É–∑–µ–π", 
                          friendship_path(friendship_record), 
                          method: :delete,
                          data: { confirm: "–£–¥–∞–ª–∏—Ç—å #{@user.email} –∏–∑ –¥—Ä—É–∑–µ–π?" },
                          class: "btn btn-outline-danger btn-sm w-100 mt-2" %>
                  <% end %>
                
                <% elsif friendship_status == :request_sent %>
                  <!-- –¢–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–ø—Ä–∞–≤–∏–ª –∑–∞—è–≤–∫—É -->
                  <% friendship_record = current_user.friendships.find_by(friend_id: @user.id, status: 'pending') %>
                  <span class="badge bg-warning text-dark mb-2">–ó–∞—è–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞</span>
                  <% if friendship_record %>
                    <%= button_to "–û—Ç–º–µ–Ω–∏—Ç—å –∑–∞—è–≤–∫—É", 
                          friendship_path(friendship_record), 
                          method: :delete,
                          data: { confirm: "–û—Ç–º–µ–Ω–∏—Ç—å –∑–∞—è–≤–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é #{@user.email}?" },
                          class: "btn btn-outline-warning btn-sm w-100 mt-2" %>
                  <% end %>
                
                <% elsif friendship_status == :request_received %>
                  <!-- –¢–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∏–ª –∑–∞—è–≤–∫—É -->
                  <% friendship_record = current_user.inverse_friendships.find_by(user_id: @user.id, status: 'pending') %>
                  <span class="badge bg-info mb-2">–ó–∞—è–≤–∫–∞ –ø–æ–ª—É—á–µ–Ω–∞</span>
                  <% if friendship_record %>
                    <div class="d-flex gap-2 mt-2">
                      <%= button_to "–ü—Ä–∏–Ω—è—Ç—å", 
                            accept_friendship_path(friendship_record), 
                            method: :patch,
                            class: "btn btn-success btn-sm flex-fill" %>
                      <%= button_to "–û—Ç–∫–ª–æ–Ω–∏—Ç—å", 
                            reject_friendship_path(friendship_record), 
                            method: :patch,
                            data: { confirm: "–û—Ç–∫–ª–æ–Ω–∏—Ç—å –∑–∞—è–≤–∫—É –æ—Ç #{@user.email}?" },
                            class: "btn btn-danger btn-sm flex-fill" %>
                    </div>
                  <% end %>
                
                <% elsif friendship_status == :rejected %>
                  <!-- –ó–∞—è–≤–∫–∞ –±—ã–ª–∞ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∞ -->
                  <span class="badge bg-secondary mb-2">–ó–∞—è–≤–∫–∞ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∞</span>
                
                <% else %>
                  <!-- –ù–µ—Ç –æ—Ç–Ω–æ—à–µ–Ω–∏–π, –º–æ–∂–Ω–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É -->
                  <% if current_user.can_send_friend_request_to?(@user) %>
                    <%= button_to "–î–æ–±–∞–≤–∏—Ç—å –≤ –¥—Ä—É–∑—å—è",
                          friendships_path(friend_id: @user.id),
                          method: :post,
                          class: "btn btn-primary w-100" %>
                  <% else %>
                    <span class="badge bg-secondary mb-2">–ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É</span>
                  <% end %>
                <% end %>
              </div>
            <% else %>
              <div class="mt-3">
                <%= link_to "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å", edit_my_profile_path,
                      class: "btn btn-info w-100 mb-2" %>
                <%= link_to "–ú–æ–∏ –∫–æ–ª–ª–µ–∫—Ü–∏–∏", collections_path,
                      class: "btn btn-success w-100 mb-2" %>
                <%= link_to "–ú–æ–∏ –¥—Ä—É–∑—å—è", friendships_path,
                      class: "btn btn-primary w-100" %>
              </div>
            <% end %>
            
            <hr>
            <small class="text-muted">
              –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω: <%= l(@user.created_at, format: :long) %><br>
              <% if @user.respond_to?(:current_sign_in_at) && @user.current_sign_in_at %>
                –ü–æ—Å–ª–µ–¥–Ω–∏–π –≤—Ö–æ–¥: <%= l(@user.current_sign_in_at, format: :short) %>
              <% end %>
            </small>
          </div>
        </div>
      </div>
      
      <!-- –ü–†–ê–í–ê–Ø –ö–û–õ–û–ù–ö–ê -->
      <div class="col-md-8">
        <!-- –û –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ï -->
        <div class="card mb-4">
          <div class="card-header">
            <h5 class="mb-0">–û –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ</h5>
          </div>
          <div class="card-body">
            <% if @profile.bio.present? %>
              <p class="lead"><%= @profile.bio %></p>
            <% else %>
              <p class="text-muted">
                <%= @user == current_user ?
                  "–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è" :
                  "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –¥–æ–±–∞–≤–∏–ª –æ–ø–∏—Å–∞–Ω–∏–µ" %>
              </p>
            <% end %>
            
            <hr>
            
            <div class="row">
              <div class="col-md-6">
                <p><strong>–°—Ç–∞—Ç—É—Å –ø—Ä–æ—Ñ–∏–ª—è:</strong><br>
                  <span class="badge <%= @user.profile.private? ? 'bg-secondary' : 'bg-success' %>">
                    <%= @user.profile.private? ? 'üîí –ü—Ä–∏–≤–∞—Ç–Ω—ã–π' : 'üåê –ü—É–±–ª–∏—á–Ω—ã–π' %>
                  </span>
                </p>
              </div>
              <div class="col-md-6">
                <p><strong>–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω:</strong><br>
                  <%= l(@user.created_at.to_date, format: :long) %>
                </p>
              </div>
            </div>
          </div>
        </div>
        
        <!-- –ö–û–õ–õ–ï–ö–¶–ò–ò -->
        <% if @can_view_collections %>
          <div class="card mb-4">
            <div class="card-header">
              <h5 class="mb-0">–ö–æ–ª–ª–µ–∫—Ü–∏–∏</h5>
            </div>
            <div class="card-body">
              <% if @top_collections && @top_collections.any? %>
                <div class="row">
                  <% @top_collections.each do |collection| %>
                    <div class="col-md-4 mb-3">
                      <div class="card h-100">
                        <div class="card-body">
                          <h6 class="card-title">
                            <%= collection.name %>
                            <span class="badge bg-secondary"><%= collection.games_count || 0 %></span>
                          </h6>
                          <% if collection.description.present? %>
                            <p class="card-text text-muted small">
                              <%= collection.description.truncate(60) %>
                            </p>
                          <% end %>
                        </div>
                        <div class="card-footer bg-transparent">
                          <%= link_to "–ü—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å", collection_path(collection), 
                                class: "btn btn-sm btn-outline-primary w-100" %>
                        </div>
                      </div>
                    </div>
                  <% end %>
                </div>
                
                <% if @collections_count && @collections_count > 3 %>
                  <div class="text-center mt-3">
                    <%= link_to "–í—Å–µ –∫–æ–ª–ª–µ–∫—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è", collections_path(user_id: @user.id), 
                          class: "btn btn-outline-secondary btn-sm" %>
                  </div>
                <% end %>
              <% else %>
                <p class="text-muted text-center py-3">
                  –£ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ–∫–∞ –Ω–µ—Ç –∫–æ–ª–ª–µ–∫—Ü–∏–π
                </p>
              <% end %>
            </div>
          </div>
        <% end %>
        
        <!-- –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–ê–Ø –ò–ù–§–û–†–ú–ê–¶–ò–Ø -->
        <div class="card">
          <div class="card-header">
            <h5 class="mb-0">–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</h5>
          </div>
          <div class="card-body">
            <ul class="list-group list-group-flush">
              <li class="list-group-item d-flex justify-content-between align-items-center">
                –ö–æ–ª–ª–µ–∫—Ü–∏–∏
                <span class="badge bg-primary rounded-pill"><%= @collections_count || 0 %></span>
              </li>
              <li class="list-group-item d-flex justify-content-between align-items-center">
                –í—Å–µ–≥–æ –∏–≥—Ä –≤ –∫–æ–ª–ª–µ–∫—Ü–∏—è—Ö
                <span class="badge bg-success rounded-pill"><%= @games_count || 0 %></span>
              </li>
              <li class="list-group-item d-flex justify-content-between align-items-center">
                –î—Ä—É–∑–µ–π
                <span class="badge bg-info rounded-pill">
                  <% if @user.respond_to?(:friend_ids) %>
                    <%= (@user.friend_ids || []).size %>
                  <% else %>
                    0
                  <% end %>
                </span>
              </li>
              <li class="list-group-item d-flex justify-content-between align-items-center">
                –ù–∞ —Å–∞–π—Ç–µ
                <span class="text-muted"><%= time_ago_in_words(@user.created_at) %></span>
              </li>
            </ul>
          </div>
        </div>
      </div>
    </div>
    
    <div class="mt-3">
      <%= link_to "‚Üê –ù–∞–∑–∞–¥", :back, class: "btn btn-outline-secondary" %>
    </div>
  <% else %>
    <div class="text-center py-5">
      <h2>–ü—Ä–æ—Ñ–∏–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω</h2>
      <p class="text-muted">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏–ª–∏ –µ–≥–æ –ø—Ä–æ—Ñ–∏–ª—å –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω.</p>
      <%= link_to "–í–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞ –≥–ª–∞–≤–Ω—É—é", root_path, class: "btn btn-primary" %>
    </div>
  <% end %>
</div>