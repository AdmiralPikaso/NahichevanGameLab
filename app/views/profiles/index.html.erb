<div class="container">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="mb-0">–ü—É–±–ª–∏—á–Ω—ã–µ –ø—Ä–æ—Ñ–∏–ª–∏</h1>
    <div>
      <%= link_to "–ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å", my_profile_path %>
    </div>
  </div>
  
  <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
  <div class="alert alert-info mb-4">
    <div class="d-flex align-items-center">
      <div class="me-3">
        <i class="bi bi-people-fill fs-4"></i>
      </div>
      <div>
        <h5 class="alert-heading mb-1">üëã –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤—É–µ–º –≤ —Å–æ–æ–±—â–µ—Å—Ç–≤–µ!</h5>
        <p class="mb-0">–ó–¥–µ—Å—å –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –ø—É–±–ª–∏—á–Ω—ã–µ –ø—Ä–æ—Ñ–∏–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π. –í—ã –º–æ–∂–µ—Ç–µ –ø—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞—Ç—å –∏—Ö –∫–æ–ª–ª–µ–∫—Ü–∏–∏ –∏ –¥–æ–±–∞–≤–ª—è—Ç—å –≤ –¥—Ä—É–∑—å—è.</p>
      </div>
    </div>
  </div>
  
  <!-- –§–∏–ª—å—Ç—Ä—ã –∏ –ø–æ–∏—Å–∫ -->
  <div class="card mb-4">
    <div class="card-body">
      <div class="row g-3">
        <div class="col-md-8">
          <%= form_tag profiles_path, method: :get, class: "row g-2" do %>
            <div class="col-md-9">
              <%= text_field_tag :search, params[:search], 
                    class: "form-control", 
                    placeholder: "–ü–æ–∏—Å–∫ –ø–æ email, –æ–ø–∏—Å–∞–Ω–∏—é..." %>
            </div>
            <div class="col-md-3">
              <%= submit_tag "–ù–∞–π—Ç–∏", class: "btn btn-primary w-100" %>
            </div>
          <% end %>
        </div>
        <div class="col-md-4">
          <div class="d-flex justify-content-end">
            <%= link_to "–°–±—Ä–æ—Å–∏—Ç—å", profiles_path, class: "btn btn-outline-secondary" %>
          </div>
        </div>
      </div>
      
      <!-- –ë—ã—Å—Ç—Ä—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã -->
      <div class="mt-3">
        <div class="btn-group btn-group-sm flex-wrap" role="group">
          <%= link_to "–í—Å–µ", profiles_path, 
                class: "btn #{params[:filter].blank? ? 'btn-primary' : 'btn-outline-primary'} mb-1" %>
          <%= link_to "–° –∫–æ–ª–ª–µ–∫—Ü–∏—è–º–∏", profiles_path(filter: 'with_collections'), 
                class: "btn #{params[:filter] == 'with_collections' ? 'btn-primary' : 'btn-outline-primary'} mb-1" %>
          <%= link_to "–ê–∫—Ç–∏–≤–Ω—ã–µ", profiles_path(filter: 'active'), 
                class: "btn #{params[:filter] == 'active' ? 'btn-primary' : 'btn-outline-primary'} mb-1" %>
        </div>
      </div>
    </div>
  </div>
  
  <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
  <div class="row mb-4">
    <div class="col-md-3">
      <div class="card text-center">
        <div class="card-body">
          <h3 class="card-title text-primary"><%= @profiles.count %></h3>
          <p class="card-text text-muted">–ü—É–±–ª–∏—á–Ω—ã—Ö –ø—Ä–æ—Ñ–∏–ª–µ–π</p>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card text-center">
        <div class="card-body">
          <h3 class="card-title text-success">
            <%= @profiles.joins(:user).where("users.created_at >= ?", 30.days.ago).count %>
          </h3>
          <p class="card-text text-muted">–ù–æ–≤—ã—Ö –∑–∞ –º–µ—Å—è—Ü</p>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card text-center">
        <div class="card-body">
          <h3 class="card-title text-warning">
            <%= @profiles.joins(:user => :collections).distinct.count %>
          </h3>
          <p class="card-text text-muted">–° –∫–æ–ª–ª–µ–∫—Ü–∏—è–º–∏</p>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card text-center">
        <div class="card-body">
          <h3 class="card-title text-info">
            <%= @profiles.where.not(bio: [nil, '']).count %>
          </h3>
          <p class="card-text text-muted">–° –æ–ø–∏—Å–∞–Ω–∏–µ–º</p>
        </div>
      </div>
    </div>
  </div>
  
  <!-- –°–ø–∏—Å–æ–∫ –ø—Ä–æ—Ñ–∏–ª–µ–π -->
  <% if @profiles.any? %>
    <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
      <% @profiles.each do |profile| %>
        <% user = profile.user %>
        <% next if user == current_user %> <!-- –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è -->
        
        <div class="col">
          <div class="card h-100 profile-card">
            <!-- –ë–µ–π–¥–∂ –∫–æ–ª–ª–µ–∫—Ü–∏–π -->
            <% if user.collections.any? %>
              <div class="position-absolute top-0 end-0 m-2">
                <span class="badge bg-success">
                  <i class="bi bi-collection"></i> <%= user.collections.count %>
                </span>
              </div>
            <% end %>
            
            <div class="card-body">
              <!-- –ê–≤–∞—Ç–∞—Ä –∏ –æ—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
              <div class="text-center mb-3">
                <% if profile.avatar.attached? %>
                  <%= image_tag profile.avatar.variant(resize: "120x120"), 
                        class: "rounded-circle border border-3 border-primary",
                        style: "width: 120px; height: 120px; object-fit: cover;" %>
                <% else %>
                  <div class="rounded-circle bg-secondary d-inline-flex align-items-center justify-content-center border border-3 border-primary" 
                       style="width: 120px; height: 120px;">
                    <span class="text-white display-5"><%= user.email[0].upcase %></span>
                  </div>
                <% end %>
              </div>
              
              <h5 class="card-title text-center mb-2">
                <%= user.email.split('@').first %>
                <small class="text-muted d-block"><%= user.email.split('@').last %></small>
              </h5>
              
              <!-- –û–ø–∏—Å–∞–Ω–∏–µ -->
              <% if profile.bio.present? %>
                <div class="card-text text-center mb-3">
                  <p class="fst-italic text-muted">
                    "<%= profile.bio.truncate(80) %>"
                  </p>
                </div>
              <% else %>
                <p class="card-text text-muted text-center mb-3">
                  <small><em>–ü–æ–∫–∞ –Ω–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è</em></small>
                </p>
              <% end %>
              
              <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è -->
              <div class="row text-center mb-3">
                <div class="col-4">
                  <div class="fw-bold"><%= user.collections.count %></div>
                  <small class="text-muted">–ö–æ–ª–ª–µ–∫—Ü–∏–π</small>
                </div>
                <div class="col-4">
                  <div class="fw-bold">
                    <%= user.collections.joins(:games).distinct.count(:game_id) %>
                  </div>
                  <small class="text-muted">–ò–≥—Ä</small>
                </div>
                <div class="col-4">
                  <div class="fw-bold">
                    <%= time_ago_in_words(user.created_at).split.first %>
                  </div>
                  <small class="text-muted">–ù–∞ —Å–∞–π—Ç–µ</small>
                </div>
              </div>
              
              <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–æ–ª–ª–µ–∫—Ü–∏—è—Ö -->
              <% if user.collections.any? %>
                <div class="mb-3">
                  <h6 class="text-muted mb-2">
                    <i class="bi bi-star-fill text-warning"></i> –ü–æ–ø—É–ª—è—Ä–Ω—ã–µ –∫–æ–ª–ª–µ–∫—Ü–∏–∏:
                  </h6>
                  <div class="d-flex flex-wrap gap-1 justify-content-center">
                    <% user.collections.limit(3).each do |collection| %>
                      <span class="badge bg-info text-dark">
                        <%= collection.name.truncate(12) %>
                      </span>
                    <% end %>
                  </div>
                </div>
              <% end %>
              
              <!-- –°—Ç–∞—Ç—É—Å –¥—Ä—É–∂–±—ã -->
              <% if Friendship.table_exists? && user != current_user %>
                <% friendship_status = current_user.friendship_status_with(user) %>
                <div class="text-center mb-3">
                  <% case friendship_status %>
                  <% when :friends %>
                    <span class="badge bg-success">
                      <i class="bi bi-check-circle"></i> –î—Ä—É–≥
                    </span>
                  <% when :request_sent %>
                    <span class="badge bg-warning text-dark">
                      <i class="bi bi-clock"></i> –ó–∞—è–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞
                    </span>
                  <% when :request_received %>
                    <span class="badge bg-info">
                      <i class="bi bi-envelope"></i> –ü—Ä–∏—Å–ª–∞–ª –∑–∞—è–≤–∫—É
                    </span>
                  <% else %>
                    <span class="badge bg-secondary">
                      <i class="bi bi-person-plus"></i> –ù–µ –≤ –¥—Ä—É–∑—å—è—Ö
                    </span>
                  <% end %>
                </div>
              <% end %>
            </div>
            
            <!-- –§—É—Ç–µ—Ä –∫–∞—Ä—Ç–æ—á–∫–∏ -->
            <div class="card-footer bg-transparent">
              <div class="d-grid gap-2">
                <!-- –û—Å–Ω–æ–≤–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ -->
                <div class="btn-group" role="group">
                  <%= link_to "–ü—Ä–æ—Ñ–∏–ª—å", profile_path(user), class: "btn btn-outline-primary" %>
                  <%= link_to "–ö–æ–ª–ª–µ–∫—Ü–∏–∏", collections_path(user_id: user.id), class: "btn btn-outline-success" %>
                </div>
                
                <!-- –ö–Ω–æ–ø–∫–∞ –¥—Ä—É–∂–±—ã -->
                <% if Friendship.table_exists? && user != current_user %>
                  <% case friendship_status %>
                  <% when :friends %>
                    <%= link_to "–£–¥–∞–ª–∏—Ç—å –∏–∑ –¥—Ä—É–∑–µ–π", 
                          friendship_path(user), 
                          method: :delete,
                          data: { confirm: "–£–¥–∞–ª–∏—Ç—å #{user.email} –∏–∑ –¥—Ä—É–∑–µ–π?" },
                          class: "btn btn-danger w-100 mt-1" %>
                  <% when :request_sent %>
                    <%= link_to "–û—Ç–º–µ–Ω–∏—Ç—å –∑–∞—è–≤–∫—É", 
                          friendship_path(user), 
                          method: :delete,
                          data: { confirm: "–û—Ç–º–µ–Ω–∏—Ç—å –∑–∞—è–≤–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é #{user.email}?" },
                          class: "btn btn-warning w-100 mt-1" %>
                  <% when :request_received %>
                    <div class="btn-group w-100 mt-1" role="group">
                      <%= link_to "–ü—Ä–∏–Ω—è—Ç—å", 
                            friendship_path(user), 
                            method: :patch,
                            class: "btn btn-success" %>
                      <%= link_to "–û—Ç–∫–ª–æ–Ω–∏—Ç—å", 
                            friendship_path(user), 
                            method: :delete,
                            class: "btn btn-danger" %>
                    </div>
                  <% else %>
                    <%= link_to "–î–æ–±–∞–≤–∏—Ç—å –≤ –¥—Ä—É–∑—å—è", 
                          friendships_path(friend_id: user.id), 
                          method: :post,
                          class: "btn btn-primary w-100 mt-1" %>
                  <% end %>
                <% end %>
              </div>
            </div>
          </div>
        </div>
      <% end %>
    </div>
    
    <!-- –ü–∞–≥–∏–Ω–∞—Ü–∏—è -->
    <div class="mt-4 text-center">
      <small class="text-muted">
        –ü–æ–∫–∞–∑–∞–Ω–æ <%= @profiles.count %> –∏–∑ <%= Profile.where(private: false).count %> –ø—É–±–ª–∏—á–Ω—ã—Ö –ø—Ä–æ—Ñ–∏–ª–µ–π
      </small>
    </div>
    
  <% else %>
    <!-- –ï—Å–ª–∏ –ø—Ä–æ—Ñ–∏–ª–µ–π –Ω–µ—Ç -->
    <div class="text-center py-5">
      <div class="mb-4">
        <i class="bi bi-emoji-frown display-1 text-muted"></i>
      </div>
      <h3 class="text-muted mb-3">–ü—Ä–æ—Ñ–∏–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</h3>
      <p class="text-muted mb-4">
        <%= params[:search].present? ? "–ü–æ –≤–∞—à–µ–º—É –∑–∞–ø—Ä–æ—Å—É –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ" : "–ü–æ–∫–∞ –Ω–µ—Ç –ø—É–±–ª–∏—á–Ω—ã—Ö –ø—Ä–æ—Ñ–∏–ª–µ–π" %>
      </p>
      <div class="d-flex justify-content-center gap-2">
        <%= link_to "–í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏", profiles_path, class: "btn btn-primary" %>
        <%= link_to "–°–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã", profiles_path, class: "btn btn-outline-primary" %>
      </div>
    </div>
  <% end %>
</div>

<style>
.profile-card {
  transition: all 0.3s ease;
  border: 1px solid #e0e0e0;
}

.profile-card:hover {
  transform: translateY(-5px);
  box-shadow: 0 10px 20px rgba(0,0,0,0.1);
  border-color: #4e73df;
}

.profile-card .card-footer {
  background: linear-gradient(to right, #f8f9fa, #ffffff);
}

.profile-card .btn-group .btn {
  border-radius: 0.25rem !important;
}

.profile-card .btn-group .btn:first-child {
  border-top-right-radius: 0 !important;
  border-bottom-right-radius: 0 !important;
}

.profile-card .btn-group .btn:last-child {
  border-top-left-radius: 0 !important;
  border-bottom-left-radius: 0 !important;
}
</style>