<div class="container">
  <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="mb-0">
      <i class="bi bi-controller"></i> –ö–∞—Ç–∞–ª–æ–≥ –∏–≥—Ä
      <small class="text-muted fs-5">(<%= @games.count %> –∏–≥—Ä)</small>
    </h1>
    <div>
      <%= link_to new_game_path, class: "btn btn-primary" do %>
        <i class="bi bi-plus-circle"></i> –î–æ–±–∞–≤–∏—Ç—å –∏–≥—Ä—É
      <% end %>
      <%= link_to wishlists_path, class: "btn btn-outline-danger ms-2" do %>
        <i class="bi bi-heart"></i> –ú–æ–π –≤–∏—à–ª–∏—Å—Ç
        <% if user_signed_in? && current_user.wishlists.any? %>
          <span class="badge bg-danger"><%= current_user.wishlists.count %></span>
        <% end %>
      <% end %>
    </div>
  </div>
  
  <!-- –§–∏–ª—å—Ç—Ä—ã –∏ –ø–æ–∏—Å–∫ -->
  <div class="card mb-4">
    <div class="card-body">
      <div class="row g-3">
        <!-- –ü–æ–∏—Å–∫ -->
        <div class="col-md-6">
          <%= form_tag games_path, method: :get, class: "row g-2" do %>
            <div class="col-md-8">
              <%= text_field_tag :search, params[:search], 
                    class: "form-control", 
                    placeholder: "–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é, –æ–ø–∏—Å–∞–Ω–∏—é..." %>
            </div>
            <div class="col-md-4">
              <%= submit_tag "–ù–∞–π—Ç–∏", class: "btn btn-primary w-100" %>
            </div>
          <% end %>
        </div>
        
        <!-- –§–∏–ª—å—Ç—Ä—ã -->
        <div class="col-md-6">
          <div class="d-flex justify-content-end gap-2">
            <!-- –§–∏–ª—å—Ç—Ä –ø–æ –≤–∏—à–ª–∏—Å—Ç—É -->
            <% if user_signed_in? %>
              <div class="dropdown">
                <button class="btn btn-outline-danger dropdown-toggle" type="button" 
                        data-bs-toggle="dropdown">
                  <i class="bi bi-heart"></i> –í–∏—à–ª–∏—Å—Ç
                </button>
                <ul class="dropdown-menu">
                  <li>
                    <%= link_to "–¢–æ–ª—å–∫–æ –≤ –º–æ–µ–º –≤–∏—à–ª–∏—Å—Ç–µ", 
                          games_path(filter: 'in_my_wishlist'), 
                          class: "dropdown-item" %>
                  </li>
                  <li>
                    <%= link_to "–ù–µ –≤ –º–æ–µ–º –≤–∏—à–ª–∏—Å—Ç–µ", 
                          games_path(filter: 'not_in_my_wishlist'), 
                          class: "dropdown-item" %>
                  </li>
                  <li><hr class="dropdown-divider"></li>
                  <li>
                    <%= link_to "–°–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä", games_path, class: "dropdown-item" %>
                  </li>
                </ul>
              </div>
            <% end %>
            
            <!-- –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ -->
            <div class="dropdown">
              <button class="btn btn-outline-secondary dropdown-toggle" type="button" 
                      data-bs-toggle="dropdown">
                <i class="bi bi-sort-down"></i> –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞
              </button>
              <ul class="dropdown-menu">
                <li>
                  <%= link_to "–ü–æ –Ω–∞–∑–≤–∞–Ω–∏—é (–ê-–Ø)", 
                        games_path(sort: 'title_asc'), 
                        class: "dropdown-item" %>
                </li>
                <li>
                  <%= link_to "–ü–æ –Ω–∞–∑–≤–∞–Ω–∏—é (–Ø-–ê)", 
                        games_path(sort: 'title_desc'), 
                        class: "dropdown-item" %>
                </li>
                <li>
                  <%= link_to "–ü–æ –¥–∞—Ç–µ –≤—ã—Ö–æ–¥–∞ (–Ω–æ–≤—ã–µ)", 
                        games_path(sort: 'release_desc'), 
                        class: "dropdown-item" %>
                </li>
                <li>
                  <%= link_to "–ü–æ —Ä–µ–π—Ç–∏–Ω–≥—É (–≤—ã—Å–æ–∫–∏–π)", 
                        games_path(sort: 'rating_desc'), 
                        class: "dropdown-item" %>
                </li>
                <li>
                  <%= link_to "–ü–æ –ø–æ–ø—É–ª—è—Ä–Ω–æ—Å—Ç–∏ –≤ –≤–∏—à–ª–∏—Å—Ç–∞—Ö", 
                        games_path(sort: 'wishlist_desc'), 
                        class: "dropdown-item" %>
                </li>
              </ul>
            </div>
            
            <%= link_to "–°–±—Ä–æ—Å–∏—Ç—å", games_path, class: "btn btn-outline-secondary" %>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
  <div class="row mb-4">
    <div class="col-md-3">
      <div class="card text-center">
        <div class="card-body">
          <h3 class="card-title text-primary"><%= @games.count %></h3>
          <p class="card-text text-muted">–í—Å–µ–≥–æ –∏–≥—Ä</p>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card text-center">
        <div class="card-body">
          <h3 class="card-title text-success">
            <%= @games.where("metacritic_score >= ?", 80).count %>
          </h3>
          <p class="card-text text-muted">–° –æ—Ü–µ–Ω–∫–æ–π 80+</p>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card text-center">
        <div class="card-body">
          <h3 class="card-title text-warning">
            <%= @games.joins(:wishlists).distinct.count %>
          </h3>
          <p class="card-text text-muted">–í –≤–∏—à–ª–∏—Å—Ç–∞—Ö</p>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card text-center">
        <div class="card-body">
          <h3 class="card-title text-info">
            <%= @games.where("release_date >= ?", Date.today).count %>
          </h3>
          <p class="card-text text-muted">–°–∫–æ—Ä–æ –≤—ã–π–¥—É—Ç</p>
        </div>
      </div>
    </div>
  </div>
  
  <!-- –°–ø–∏—Å–æ–∫ –∏–≥—Ä -->
  <% if @games.any? %>
    <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
      <% @games.each do |game| %>
        <div class="col">
          <div class="card h-100 game-card">
            <!-- –ë–µ–π–¥–∂ –≤–∏—à–ª–∏—Å—Ç–∞ -->
            <% if user_signed_in? && current_user.wishlists.where(game: game).exists? %>
              <div class="position-absolute top-0 end-0 m-2">
                <span class="badge bg-danger p-2">
                  <i class="bi bi-heart-fill"></i>
                </span>
              </div>
            <% end %>
            
            <!-- –û–±–ª–æ–∂–∫–∞ –∏–≥—Ä—ã -->
            <% if game.cover_url.present? %>
              <div class="game-cover-container">
                <img src="<%= game.cover_url %>" 
                     alt="<%= game.title %>" 
                     class="card-img-top"
                     style="height: 200px; object-fit: cover;">
                
                <!-- –ù–∞–ª–æ–∂–µ–Ω–∏–µ —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π -->
                <div class="game-overlay">
                  <% if game.metacritic_score.present? %>
                    <span class="badge bg-<%= game.metacritic_score >= 75 ? 'success' : game.metacritic_score >= 50 ? 'warning' : 'danger' %> score-badge">
                      <%= game.metacritic_score %>
                    </span>
                  <% end %>
                  
                  <!-- –ö–Ω–æ–ø–∫–∞ –±—ã—Å—Ç—Ä–æ–≥–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤ –≤–∏—à–ª–∏—Å—Ç -->
                  <% if user_signed_in? %>
                    <div class="quick-actions">
                      <% if current_user.wishlists.where(game: game).exists? %>
                        <% wishlist_item = current_user.wishlists.find_by(game: game) %>
                        <%= link_to wishlist_path(wishlist_item), 
                              method: :delete,
                              class: "btn btn-sm btn-danger",
                              data: { 
                                confirm: "–£–¥–∞–ª–∏—Ç—å '#{game.title}' –∏–∑ –≤–∏—à–ª–∏—Å—Ç–∞?" 
                              },
                              title: "–£–¥–∞–ª–∏—Ç—å –∏–∑ –≤–∏—à–ª–∏—Å—Ç–∞" do %>
                          <i class="bi bi-heartbreak-fill"></i>
                        <% end %>
                      <% else %>
                        <%= link_to quick_add_wishlists_path(game_id: game.id, priority: 'medium'), 
                              method: :post,
                              class: "btn btn-sm btn-outline-light",
                              title: "–ë—ã—Å—Ç—Ä–æ –¥–æ–±–∞–≤–∏—Ç—å –≤ –≤–∏—à–ª–∏—Å—Ç" do %>
                          <i class="bi bi-heart"></i>
                        <% end %>
                      <% end %>
                    </div>
                  <% end %>
                </div>
              </div>
            <% end %>
            
            <!-- –ö–æ–Ω—Ç–µ–Ω—Ç –∫–∞—Ä—Ç–æ—á–∫–∏ -->
            <div class="card-body">
              <h5 class="card-title">
                <%= link_to game.title, game_path(game), class: "text-decoration-none" %>
              </h5>
              
              <!-- –ú–µ—Ç–∞-–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
              <div class="game-meta mb-3">
                <% if game.release_date %>
                  <div class="mb-1">
                    <small class="text-muted">
                      <i class="bi bi-calendar"></i>
                      <%= l(game.release_date, format: :short) %>
                      <% if game.release_date > Date.today %>
                        <span class="badge bg-warning text-dark ms-1">
                          <i class="bi bi-clock"></i> –°–∫–æ—Ä–æ
                        </span>
                      <% end %>
                    </small>
                  </div>
                <% end %>
                
                <% if game.developers.any? %>
                  <div class="mb-1">
                    <small class="text-muted">
                      <i class="bi bi-people"></i>
                      <%= game.developers.first.name %>
                      <% if game.developers.count > 1 %>
                        <span class="badge bg-secondary ms-1">+<%= game.developers.count - 1 %></span>
                      <% end %>
                    </small>
                  </div>
                <% end %>
                
                <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
                <div class="d-flex justify-content-between mt-2">
                  <small class="text-muted">
                    <i class="bi bi-heart text-danger"></i>
                    <%= game.wishlists.count %> –≤ –≤–∏—à–ª–∏—Å—Ç–∞—Ö
                  </small>
                  <small class="text-muted">
                    <i class="bi bi-folder text-primary"></i>
                    <%= game.collections.count %> –≤ –∫–æ–ª–ª–µ–∫—Ü–∏—è—Ö
                  </small>
                </div>
              </div>
              
              <!-- –û–ø–∏—Å–∞–Ω–∏–µ -->
              <% if game.description.present? %>
                <p class="card-text text-muted small">
                  <%= truncate(game.description, length: 100) %>
                </p>
              <% end %>
            </div>
            
            <!-- –§—É—Ç–µ—Ä –∫–∞—Ä—Ç–æ—á–∫–∏ -->
            <div class="card-footer bg-transparent">
              <div class="d-flex justify-content-between align-items-center">
                <div class="btn-group btn-group-sm">
                  <%= link_to "–ü—Ä–æ—Å–º–æ—Ç—Ä", game_path(game), class: "btn btn-outline-primary" %>
                  <%= link_to "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å", edit_game_path(game), class: "btn btn-outline-secondary" %>
                </div>
                
                <!-- –ö–Ω–æ–ø–∫–∞ —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–≥–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤ –≤–∏—à–ª–∏—Å—Ç -->
                <% if user_signed_in? && !current_user.wishlists.where(game: game).exists? %>
                  <button type="button" 
                          class="btn btn-sm btn-outline-danger"
                          data-bs-toggle="modal" 
                          data-bs-target="#wishlistModal<%= game.id %>"
                          title="–î–æ–±–∞–≤–∏—Ç—å –≤ –≤–∏—à–ª–∏—Å—Ç">
                    <i class="bi bi-heart"></i>
                  </button>
                <% end %>
              </div> <!-- –î–æ–±–∞–≤–ª–µ–Ω –∑–∞–∫—Ä—ã–≤–∞—é—â–∏–π —Ç–µ–≥ -->
            </div> <!-- –î–æ–±–∞–≤–ª–µ–Ω –∑–∞–∫—Ä—ã–≤–∞—é—â–∏–π —Ç–µ–≥ –¥–ª—è card-footer -->
          </div> <!-- –î–æ–±–∞–≤–ª–µ–Ω –∑–∞–∫—Ä—ã–≤–∞—é—â–∏–π —Ç–µ–≥ –¥–ª—è card -->
        </div> <!-- –î–æ–±–∞–≤–ª–µ–Ω –∑–∞–∫—Ä—ã–≤–∞—é—â–∏–π —Ç–µ–≥ –¥–ª—è col -->
        
        <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤ –≤–∏—à–ª–∏—Å—Ç (–¥–ª—è –∫–∞–∂–¥–æ–π –∏–≥—Ä—ã) -->
        <% if user_signed_in? && !current_user.wishlists.where(game: game).exists? %>
          <div class="modal fade" id="wishlistModal<%= game.id %>" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-sm">
              <div class="modal-content">
                <div class="modal-header">
                  <h6 class="modal-title">–î–æ–±–∞–≤–∏—Ç—å –≤ –≤–∏—à–ª–∏—Å—Ç</h6>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <%= form_with(url: wishlists_path, method: :post, local: true) do |form| %>
                  <%= hidden_field_tag :game_id, game.id %>
                  <div class="modal-body">
                    <p class="small mb-3">
                      <strong><%= game.title %></strong>
                    </p>
                    
                    <div class="mb-3">
                      <label class="form-label small">–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:</label>
                      <select name="priority" class="form-select form-select-sm">
                        <option value="high">üîº –í—ã—Å–æ–∫–∏–π</option>
                        <option value="medium" selected>‚ÜîÔ∏è –°—Ä–µ–¥–Ω–∏–π</option>
                        <option value="low">üîΩ –ù–∏–∑–∫–∏–π</option>
                      </select>
                    </div>
                  </div>
                  <div class="modal-footer justify-content-center">
                    <button type="submit" class="btn btn-danger btn-sm w-100">
                      <i class="bi bi-heart-fill"></i> –î–æ–±–∞–≤–∏—Ç—å
                    </button>
                  </div>
                <% end %>
              </div>
            </div>
          </div>
        <% end %>
      <% end %>
    </div>
    
    <!-- –ü–∞–≥–∏–Ω–∞—Ü–∏—è (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ) -->
    <div class="mt-4 text-center">
      <small class="text-muted">
        –ü–æ–∫–∞–∑–∞–Ω–æ <%= @games.count %> –∏–∑ <%= Game.count %> –∏–≥—Ä
      </small>
    </div>
    
  <% else %>
    <!-- –ï—Å–ª–∏ –∏–≥—Ä –Ω–µ—Ç -->
    <div class="text-center py-5">
      <div class="mb-4">
        <i class="bi bi-controller display-1 text-muted"></i>
      </div>
      <h3 class="text-muted mb-3">–ò–≥—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</h3>
      <p class="text-muted mb-4">
        <%= params[:search].present? ? "–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–∏—Å–∫–∞" : "–î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤—É—é –∏–≥—Ä—É –≤ –∫–∞—Ç–∞–ª–æ–≥" %>
      </p>
      <div class="d-flex justify-content-center gap-3">
        <%= link_to "–î–æ–±–∞–≤–∏—Ç—å –∏–≥—Ä—É", new_game_path, class: "btn btn-primary" %>
        <%= link_to "–°–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã", games_path, class: "btn btn-outline-primary" %>
      </div>
    </div>
  <% end %>
</div>

<style>
.game-card {
  transition: all 0.3s ease;
  border: 1px solid #e0e0e0;
  position: relative;
}

.game-card:hover {
  transform: translateY(-5px);
  box-shadow: 0 10px 20px rgba(0,0,0,0.1);
  border-color: #4e73df;
}

.game-cover-container {
  position: relative;
  overflow: hidden;
}

.game-overlay {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: linear-gradient(to bottom, rgba(0,0,0,0.1) 0%, rgba(0,0,0,0.3) 100%);
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  padding: 10px;
}

.score-badge {
  font-size: 0.9rem;
  font-weight: bold;
}

.quick-actions {
  opacity: 0;
  transition: opacity 0.3s;
}

.game-card:hover .quick-actions {
  opacity: 1;
}

.game-meta {
  border-top: 1px solid #f0f0f0;
  border-bottom: 1px solid #f0f0f0;
  padding: 10px 0;
}

.card-footer {
  background: linear-gradient(to right, #f8f9fa, #ffffff);
}

.btn-group .btn {
  border-radius: 4px;
}

.btn-group .btn:first-child {
  border-top-right-radius: 0;
  border-bottom-right-radius: 0;
}

.btn-group .btn:last-child {
  border-top-left-radius: 0;
  border-bottom-left-radius: 0;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –∫–∞—Ä—Ç–æ—á–µ–∫ –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏
  const gameCards = document.querySelectorAll('.game-card');
  gameCards.forEach(card => {
    card.addEventListener('mouseenter', function() {
      this.style.zIndex = '10';
    });
    
    card.addEventListener('mouseleave', function() {
      this.style.zIndex = '1';
    });
  });
  
  // –û–±—Ä–∞–±–æ—Ç–∫–∞ –±—ã—Å—Ç—Ä–æ–≥–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤ –≤–∏—à–ª–∏—Å—Ç
  const quickWishlistButtons = document.querySelectorAll('[data-game-id]');
  quickWishlistButtons.forEach(button => {
    button.addEventListener('click', function(e) {
      e.preventDefault();
      
      const gameId = this.getAttribute('data-game-id');
      const gameTitle = this.getAttribute('data-game-title');
      
      // AJAX –∑–∞–ø—Ä–æ—Å –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è
      fetch(`/wishlists/quick_add?game_id=${gameId}&priority=medium`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRF-Token': document.querySelector('[name="csrf-token"]').content
        }
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          // –û–±–Ω–æ–≤–ª—è–µ–º UI
          this.innerHTML = '<i class="bi bi-heartbreak-fill"></i>';
          this.classList.remove('btn-outline-light');
          this.classList.add('btn-danger');
          this.setAttribute('title', '–£–¥–∞–ª–∏—Ç—å –∏–∑ –≤–∏—à–ª–∏—Å—Ç–∞');
          
          // –ú–µ–Ω—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫
          this.onclick = function(e) {
            e.preventDefault();
            if (confirm(`–£–¥–∞–ª–∏—Ç—å "${gameTitle}" –∏–∑ –≤–∏—à–ª–∏—Å—Ç–∞?`)) {
              fetch(`/wishlists/${data.wishlist_id}`, {
                method: 'DELETE',
                headers: {
                  'X-CSRF-Token': document.querySelector('[name="csrf-token"]').content
                }
              })
              .then(() => {
                this.innerHTML = '<i class="bi bi-heart"></i>';
                this.classList.remove('btn-danger');
                this.classList.add('btn-outline-light');
                this.setAttribute('title', '–ë—ã—Å—Ç—Ä–æ –¥–æ–±–∞–≤–∏—Ç—å –≤ –≤–∏—à–ª–∏—Å—Ç');
              });
            }
          };
          
          // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
          showToast('–ò–≥—Ä–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤ –≤–∏—à–ª–∏—Å—Ç!', 'success');
        }
      })
      .catch(error => {
        console.error('Error:', error);
        showToast('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –≤ –≤–∏—à–ª–∏—Å—Ç', 'error');
      });
    });
  });
  
  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ —Ç–æ—Å—Ç–æ–≤
  function showToast(message, type = 'info') {
    const toastContainer = document.getElementById('toast-container') || createToastContainer();
    const toastId = 'toast-' + Date.now();
    
    const toast = document.createElement('div');
    toast.className = `toast align-items-center text-bg-${type === 'success' ? 'success' : 'danger'} border-0`;
    toast.id = toastId;
    toast.setAttribute('role', 'alert');
    toast.setAttribute('aria-live', 'assertive');
    toast.setAttribute('aria-atomic', 'true');
    
    toast.innerHTML = `
      <div class="d-flex">
        <div class="toast-body">
          ${message}
        </div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
      </div>
    `;
    
    toastContainer.appendChild(toast);
    
    const bsToast = new bootstrap.Toast(toast);
    bsToast.show();
    
    toast.addEventListener('hidden.bs.toast', function () {
      this.remove();
    });
  }
  
  function createToastContainer() {
    const container = document.createElement('div');
    container.id = 'toast-container';
    container.className = 'toast-container position-fixed bottom-0 end-0 p-3';
    container.style.zIndex = '1055';
    document.body.appendChild(container);
    return container;
  }
});
</script>