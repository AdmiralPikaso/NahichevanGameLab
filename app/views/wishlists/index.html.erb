<div class="container">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="mb-0">üéÆ –ú–æ–π –≤–∏—à–ª–∏—Å—Ç</h1>
    <div>
      <%= link_to "–í—Å–µ –∏–≥—Ä—ã", games_path, class: "btn btn-outline-primary me-2" %>
      <%= link_to "–ú–æ–∏ –∫–æ–ª–ª–µ–∫—Ü–∏–∏", collections_path, class: "btn btn-outline-success" %>
    </div>
  </div>
  
  <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
  <div class="row mb-4">
    <div class="col-md-3">
      <div class="card text-center">
        <div class="card-body">
          <h2 class="card-title text-primary"><%= @total_games %></h2>
          <p class="card-text text-muted">–í—Å–µ–≥–æ –∏–≥—Ä –≤ –≤–∏—à–ª–∏—Å—Ç–µ</p>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card text-center">
        <div class="card-body">
          <h2 class="card-title text-warning"><%= @high_priority_count %></h2>
          <p class="card-text text-muted">–í—ã—Å–æ–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç</p>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card text-center">
        <div class="card-body">
          <h2 class="card-title text-success">
            <%= number_to_currency(@estimated_cost, unit: "‚ÇΩ", precision: 0) %>
          </h2>
          <p class="card-text text-muted">–ü—Ä–∏–º–µ—Ä–Ω–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å</p>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card text-center">
        <div class="card-body">
          <h2 class="card-title text-info">
            <%= @wishlists.recently_added.count %>
          </h2>
          <p class="card-text text-muted">–î–æ–±–∞–≤–ª–µ–Ω–æ –∑–∞ –º–µ—Å—è—Ü</p>
        </div>
      </div>
    </div>
  </div>
  
  <!-- –§–∏–ª—å—Ç—Ä—ã –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ -->
  <div class="card mb-4">
    <div class="card-body">
      <div class="row align-items-center">
        <div class="col-md-6">
          <h5 class="mb-0">–§–∏–ª—å—Ç—Ä –ø–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—É:</h5>
        </div>
        <div class="col-md-6">
          <div class="btn-group btn-group-sm float-end" role="group">
            <%= link_to "–í—Å–µ", wishlists_path, 
                  class: "btn #{@selected_priority.blank? ? 'btn-primary' : 'btn-outline-primary'}" %>
            <% @priorities.each do |priority| %>
              <%= link_to priority.humanize, wishlists_path(priority: priority), 
                    class: "btn #{@selected_priority == priority ? 'btn-primary' : 'btn-outline-primary'}" %>
            <% end %>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- –°–ø–∏—Å–æ–∫ –∏–≥—Ä –≤ –≤–∏—à–ª–∏—Å—Ç–µ -->
  <% if @wishlists.any? %>
    <!-- –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—É -->
    <% @grouped_wishlists.each do |priority, wishlists_for_priority| %>
      <% next if wishlists_for_priority.empty? %>
      
      <div class="card mb-4 border-<%= Wishlist.new(priority: priority).priority_color %>">
        <div class="card-header bg-<%= Wishlist.new(priority: priority).priority_color %> text-white">
          <h5 class="mb-0">
            <%= Wishlist.new(priority: priority).priority_icon %>
            <%= priority.humanize %> –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç
            <span class="badge bg-light text-dark ms-2"><%= wishlists_for_priority.count %></span>
          </h5>
        </div>
        
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-hover">
              <thead>
                <tr>
                  <th style="width: 5%">#</th>
                  <th style="width: 40%">–ò–≥—Ä–∞</th>
                  <th style="width: 25%">–†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∏</th>
                  <th style="width: 15%">–î–∞—Ç–∞ –≤—ã—Ö–æ–¥–∞</th>
                  <th style="width: 15%">–î–µ–π—Å—Ç–≤–∏—è</th>
                </tr>
              </thead>
              <tbody>
                <% wishlists_for_priority.each_with_index do |wishlist, index| %>
                  <% game = wishlist.game %>
                  <tr>
                    <td><%= index + 1 %></td>
                    <td>
                      <strong><%= link_to game.title, game_path(game) %></strong>
                      <% if wishlist.notes.present? %>
                        <br>
                        <small class="text-muted">
                          <i class="bi bi-chat-left-text"></i> <%= wishlist.notes.truncate(50) %>
                        </small>
                      <% end %>
                    </td>
                    <td>
                      <% if game.developers.any? %>
                        <%= game.developers.map(&:name).join(", ") %>
                      <% else %>
                        <span class="text-muted">–ù–µ —É–∫–∞–∑–∞–Ω—ã</span>
                      <% end %>
                    </td>
                    <td>
                      <% if game.release_date %>
                        <%= l(game.release_date, format: :short) %>
                        <% if game.release_date > Date.today %>
                          <br>
                          <small class="text-warning">
                            <i class="bi bi-clock"></i> –°–∫–æ—Ä–æ
                          </small>
                        <% end %>
                      <% else %>
                        <span class="text-muted">–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ</span>
                      <% end %>
                    </td>
                    <td>
                      <div class="btn-group btn-group-sm" role="group">
                        <!-- –ò–∑–º–µ–Ω–∏—Ç—å –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç -->
                        <div class="dropdown">
                          <button class="btn btn-outline-secondary dropdown-toggle" type="button" 
                                  data-bs-toggle="dropdown">
                            <%= wishlist.priority_icon %>
                          </button>
                          <ul class="dropdown-menu">
                            <% Wishlist.priorities.keys.each do |p| %>
                              <li>
                                <%= form_with(url: update_priority_wishlist_path(wishlist), method: :patch, 
                                              class: "dropdown-item p-0") do |form| %>
                                  <%= hidden_field_tag :priority, p %>
                                  <button type="submit" class="btn btn-link p-2 border-0 text-start w-100">
                                    <%= Wishlist.new(priority: p).priority_icon %>
                                    <%= p.humanize %>
                                  </button>
                                <% end %>
                              </li>
                            <% end %>
                          </ul>
                        </div>
                        
                        <!-- –£–¥–∞–ª–∏—Ç—å –∏–∑ –≤–∏—à–ª–∏—Å—Ç–∞ -->
                        <%= form_with(url: wishlist_path(wishlist), method: :delete, 
                              class: "d-inline", id: "delete-form-#{wishlist.id}") do %>
                          <button type="submit" 
                                  class="btn btn-outline-danger"
                                  onclick="return confirm('–£–¥–∞–ª–∏—Ç—å &quot;<%= game.title %>&quot; –∏–∑ –≤–∏—à–ª–∏—Å—Ç–∞?');"
                                  title="–£–¥–∞–ª–∏—Ç—å –∏–∑ –≤–∏—à–ª–∏—Å—Ç–∞">
                            üóëÔ∏è
                          </button>
                        <% end %>
                      </div>
                    </td>
                  </tr>
                <% end %>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    <% end %>
    
    <!-- –≠–∫—Å–ø–æ—Ä—Ç –∏ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è -->
    <div class="card">
      <div class="card-body text-center">
        <h5>–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è</h5>
        <div class="btn-group mt-2">
          <%= link_to "–ü–æ–¥–µ–ª–∏—Ç—å—Å—è —Å–ø–∏—Å–∫–æ–º", "#", class: "btn btn-outline-primary" %>
          <%= link_to "–°–æ–∑–¥–∞—Ç—å –∫–æ–ª–ª–µ–∫—Ü–∏—é –∏–∑ –≤–∏—à–ª–∏—Å—Ç–∞", new_collection_path, class: "btn btn-outline-success" %>
          <%= link_to "–û—á–∏—Å—Ç–∏—Ç—å –≤–∏—à–ª–∏—Å—Ç", "#", 
                class: "btn btn-outline-danger",
                data: { confirm: "–£–¥–∞–ª–∏—Ç—å –≤—Å–µ –∏–≥—Ä—ã –∏–∑ –≤–∏—à–ª–∏—Å—Ç–∞?" } %>
        </div>
      </div>
    </div>
    
  <% else %>
    <!-- –ï—Å–ª–∏ –≤–∏—à–ª–∏—Å—Ç –ø—É—Å—Ç -->
    <div class="text-center py-5">
      <div class="mb-4">
        <i class="bi bi-emoji-frown display-1 text-muted"></i>
      </div>
      <h3 class="text-muted mb-3">–í–∞—à –≤–∏—à–ª–∏—Å—Ç –ø—É—Å—Ç</h3>
      <p class="text-muted mb-4">
        –î–æ–±–∞–≤–ª—è–π—Ç–µ –∏–≥—Ä—ã, –∫–æ—Ç–æ—Ä—ã–µ —Ö–æ—Ç–∏—Ç–µ –ø—Ä–∏–æ–±—Ä–µ—Å—Ç–∏ –∏–ª–∏ –ø—Ä–æ–π—Ç–∏ –≤ –±—É–¥—É—â–µ–º
      </p>
      <div class="d-flex justify-content-center gap-3">
        <%= link_to "–ù–∞–π—Ç–∏ –∏–≥—Ä—ã", games_path, class: "btn btn-primary btn-lg" %>
        <%= link_to "–ü–æ–ø—É–ª—è—Ä–Ω—ã–µ –∏–≥—Ä—ã", "#", class: "btn btn-outline-primary btn-lg" %>
      </div>
    </div>
  <% end %>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤ –∫–æ–ª–ª–µ–∫—Ü–∏—é -->
<div class="modal fade" id="addToCollectionModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">–î–æ–±–∞–≤–∏—Ç—å –≤ –∫–æ–ª–ª–µ–∫—Ü–∏—é</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>–ò–≥—Ä–∞: <strong id="modalGameTitle"></strong></p>
        <%= form_with(url: "#", method: :post, id: "addToCollectionForm") do |form| %>
          <%= hidden_field_tag :game_id, "", id: "modalGameId" %>
          <div class="mb-3">
            <label class="form-label">–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–ª–ª–µ–∫—Ü–∏—é:</label>
            <select name="collection_id" class="form-select" required>
              <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–ª–ª–µ–∫—Ü–∏—é...</option>
              <% current_user.collections.each do |collection| %>
                <option value="<%= collection.id %>"><%= collection.name %></option>
              <% end %>
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):</label>
            <%= text_area_tag :notes, "", class: "form-control", rows: 3 %>
          </div>
        <% end %>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
        <button type="button" class="btn btn-primary" id="submitAddToCollection">–î–æ–±–∞–≤–∏—Ç—å</button>
      </div>
    </div>
  </div>
</div>

<!-- JavaScript –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π -->
<script>
document.addEventListener('DOMContentLoaded', function() {
  // –û–±—Ä–∞–±–æ—Ç–∫–∞ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤ –∫–æ–ª–ª–µ–∫—Ü–∏—é
  const addToCollectionModal = document.getElementById('addToCollectionModal');
  if (addToCollectionModal) {
    addToCollectionModal.addEventListener('show.bs.modal', function(event) {
      const button = event.relatedTarget;
      const gameTitle = button.getAttribute('data-game-title');
      const gameId = button.getAttribute('data-game-id');
      
      document.getElementById('modalGameTitle').textContent = gameTitle;
      document.getElementById('modalGameId').value = gameId;
      
      // –û–±–Ω–æ–≤–ª—è–µ–º —Ñ–æ—Ä–º—É
      const form = document.getElementById('addToCollectionForm');
      form.action = `/collections/${document.querySelector('select[name="collection_id"]').value}/add_game/${gameId}`;
    });
    
    // –û–±–Ω–æ–≤–ª—è–µ–º action —Ñ–æ—Ä–º—ã –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –≤—ã–±–æ—Ä–∞ –∫–æ–ª–ª–µ–∫—Ü–∏–∏
    const collectionSelect = document.querySelector('#addToCollectionModal select[name="collection_id"]');
    if (collectionSelect) {
      collectionSelect.addEventListener('change', function() {
        const form = document.getElementById('addToCollectionForm');
        const gameId = document.getElementById('modalGameId').value;
        form.action = `/collections/${this.value}/add_game/${gameId}`;
      });
    }
    
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–Ω–æ–ø–∫–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏
    const submitBtn = document.getElementById('submitAddToCollection');
    if (submitBtn) {
      submitBtn.addEventListener('click', function() {
        document.getElementById('addToCollectionForm').submit();
      });
    }
  }
  
  // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ JavaScript –¥–ª—è —Ñ–æ—Ä–º
  console.log('JavaScript –∑–∞–≥—Ä—É–∂–µ–Ω, —Ñ–æ—Ä–º—ã –¥–æ–ª–∂–Ω—ã —Ä–∞–±–æ—Ç–∞—Ç—å');
  
  // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ —Å—Ç—Ä–æ–∫ —Ç–∞–±–ª–∏—Ü—ã
  const tableRows = document.querySelectorAll('table tbody tr');
  tableRows.forEach(row => {
    row.addEventListener('mouseenter', function() {
      this.style.backgroundColor = '#f8f9fa';
    });
    row.addEventListener('mouseleave', function() {
      this.style.backgroundColor = '';
    });
  });
});

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–∞–±–æ—Ç—ã JavaScript
function testDelete() {
  console.log('Delete form submit —Ä–∞–±–æ—Ç–∞–µ—Ç');
  return true;
}
</script>

<style>
.card {
  transition: transform 0.2s;
}

.card:hover {
  transform: translateY(-2px);
}

.table-hover tbody tr:hover {
  background-color: rgba(0, 123, 255, 0.05) !important;
}

.btn-group .dropdown-toggle::after {
  margin-left: 0.5em;
}

.dropdown-menu .dropdown-item {
  padding: 0;
}

.dropdown-menu .dropdown-item button {
  width: 100%;
  text-align: left;
  background: none;
  border: none;
  padding: 8px 16px;
}

.dropdown-menu .dropdown-item button:hover {
  background-color: #f8f9fa;
}
</style>